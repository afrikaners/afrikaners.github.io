<!DOCTYPE html>
<html>

<head>
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="raphael.min.js"></script>
    <script type="text/javascript" src="justgage.min.js"></script>
    <script type="text/javascript" src="nosleep.js"></script>
    <script type="text/javascript" src="papaparse.js"></script>
    <!-- <script type="text/javascript" src="jquery.csv.min.js"></script>  -->
    
    <style>
        body {
            height: 4000px;
            background-color: black;
            color: white;
        }
        html{
            background-color: black;
        }

        .green {
            color: lightgreen;
        }

        .newRecord{
            font-size: smaller;
            color:green;
        }
        .noRecord{
            font-size: smaller;
            color:red;
        }

        /* Small devices (tablets, 768px and up) */
        @media (min-width: @screen-sm-min) {}

        /* Medium devices (desktops, 992px and up) */
        @media (min-width: @screen-md-min) {}

        /* Large devices (large desktops, 1200px and up) */
        @media (min-width: @screen-lg-min) {}
    </style>
</head>

<body id="body">
    <nav class="navbar navbar-inverse navbar-static-top">
        <div class="container">
            <ul class="nav navbar-nav">
                <li id="home" class="active tab" onclick="changeTab('home');"><a href="#">Home</a></li>
                <li id="pvOutput" class="tab"><a href="#" onclick="changeTab('pvOutput');">PV Output</a></li>
                <li id="pvOutputRecord" class="tab"><a href="#" onclick="changeTab('pvOutputRecord');">PVO Record</a></li>
                <li id="pvOutputDaily" class="tab"><a href="#" onclick="changeTab('pvOutputDaily');">PVO Daily</a></li>
                <li id="savings" class="tab"><a href="#" onclick="changeTab('savings');">Savings</a></li>
                <li id="settings" class="tab"><a href="#" onclick="changeTab('settings');">Settings</a></li>
              </ul>
        </div>
      </nav>
    <div id="homeSection" class="row section">
        <div class="col-xs-1">&nbsp;</div>
        <div class="col-xs-5" >
            
            <div class="row">
                <div class="col-xs-12"><h1>Realtime Generation:</h1></div>
            </div>
            <div class="row" style="height:155px;overflow:hidden;">
                <div class="col-xs-12">
                    <div style="width:400px;height:155px;overflow:hidden;" id="gauge"></div>
                    <div style="width:100%;text-align:center;position:relative; top: -90px;">
                        <h1 style="" id="powerGen">Loading...</h1>
                        <h4 style="position:relative;top:-80px;" id="percentage"></h4>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    
                   
                    <h3>Total for today:</h3>
                    <h3 id="powerTotal"></h3>
                    
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <h1 id="skottelgoed" style="display:none" class="green">Skottelgoed Wasser</h1>
                    <h1 id="oond" style="display:none" class="green">Oond</h1>
                    <h1 id="wasmasjien" style="display:none" class="green">Wasmasjien</h1>
                    <h1 id="aircon" style="display:none" class="green">Aircon</h1>
                </div>
            </div>

        </div>
        <div class="col-xs-6">

            <div class="row">
                <div style="width: 500px;margin-top:30px;"><iframe id="weatherWidget" style="display: block;" src="" width="500" height="520" frameborder="0"  scrolling="no"></iframe><a style="text-indent: -9999em;position: relative;z-index: 1;display: block;margin: -20px 0 0 0;height: 20px" href="https://www.willyweather.com.au/wa/perth/yanchep.html" rel="nofollow">Weather info for Yanchep</a></div>
            </div>

        </div>
    </div>
    <div id="pvOutputSection" style="display:none;" class="row section">
        <div class="col-xs-12">
            <iframe id="pvOutputIframe" style="display: block;" src="" width="1024" height="4000" frameborder="0"  scrolling="no"></iframe>
        </div>
    </div>
    <div id="settingsSection" style="display:none;" class="row section">
        <div class="col-xs-12">
            <div class="row">
                <div class="col-xs-12">
                    <input type="button" id="toggle" value="Wake Lock is disabled" /><br/>
                    <input type="button" id="notifyAircon" value="Notify Aircon Threshold: false" />
                    <div id="error"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>
    <script>
        var gauge;
        var recordData;

        var queryString = new Array();
        var newHighAlertSent = false;
        var notifyAirconThreshold = false;
        var airconThresholdBreachCounter = 0;
        var maxNotifications = 10;
        var notificationCounter = 0;
        var timeout = 6000;


        try{
            Papa.parse("https://afrikaners.github.io/record.csv", {
                download: true,
                complete: function(results) {
                    recordData = results.data;
                }
            });
        }catch(ex){
            console.log(ex);
        }

        $(document).ready(function () {
            if (queryString.length == 0) {
                if (window.location.search.split('?').length > 1) {
                    var params = window.location.search.split('?')[1].split('&');
                    for (var i = 0; i < params.length; i++) {
                        var key = params[i].split('=')[0];
                        var value = decodeURIComponent(params[i].split('=')[1]);
                        queryString[key] = value;
                    }
                }
            }

            $('#notifyAircon').click(function(){
                notifyAirconThreshold = !notifyAirconThreshold;
                $('#notifyAircon').attr('value', 'Notify Aircon Threshold: ' + notifyAirconThreshold);
            });

            load();
            loadWeather();
            var noSleep = new NoSleep();

            var wakeLockEnabled = false;
            var toggleEl = document.querySelector("#toggle");
            toggleEl.addEventListener('click', function () {
                if (!wakeLockEnabled) {
                    noSleep.enable(); // keep the screen on!
                    wakeLockEnabled = true;
                    toggleEl.value = "Wake Lock is enabled";
                    //document.getElementById("toggle").style.display = "none";
                    //document.body.style.backgroundColor = "green";
                } else {
                    noSleep.disable(); // let the screen turn off.
                    wakeLockEnabled = false;
                    toggleEl.value = "Wake Lock is disabled";
                    //document.body.style.backgroundColor = "";
                }
            }, false);

        try{
            gauge = new JustGage({
                    id: "gauge", // the id of the html element
                    value: 0,
                    min: 0,
                    max: 100,
                    decimals: 2,
                    levelColors: ["#ff0000", "#f9c802", "#00b800"],
                    gaugeWidthScale: 0.6
                });
                //gauge.refresh(24);
        }catch(ex){
            $('#error').text(ex.message);
        }
           

            function loadWeather(){
                try{
                    console.log('reloading weather...');
                    $('#weatherWidget').attr('src', "https://cdnres.willyweather.com.au/widget/loadView.html?id=57109");
                    setTimeout(function () { loadWeather(); }, 900000);
                }catch(ex){
                    setTimeout(function () { loadWeather(); }, 900000);
                }
            }

            function checkAndSendAirconThresholdNotification(powerGenLevel){
                if(notifyAirconThreshold && airconThresholdBreachCounter == 4){
                    notifyAirconThreshold = false; 
                    airconThresholdBreachCounter = 0;
                    $('#notifyAircon').attr('value', 'Notify Aircon Threshold: ' + notifyAirconThreshold);
                    sendNotification("Aircon Threshold alert", "Solar below Aircon ON threshold. (" + powerGenLevel + " w)");
                }else if(notifyAirconThreshold){
                    airconThresholdBreachCounter ++;
                }
            }

            function load() {
                try{
                    $.get("https://valuehold2.apphb.com/api/values", function (data) {
                        // alert( "Data Loaded: " +  );
                        var dataString = JSON.stringify(data);
                        //console.log(dataString);
                        dataString = dataString.replace(/\\n/g, "");
                        dataString = dataString.replace(/\\/g, "");
                        dataString = dataString.replace(/ /g, '');
                        dataString = dataString.substring(1);
                        dataString = dataString.substring(0, dataString.length - 1);

                        var obj = JSON.parse(dataString);
                        var powerGenVal = obj.Body.PAC.Values["1"];
                        var integer = parseInt(powerGenVal, 10);
                        
                        if (integer > 1000) {
                            $("#powerGen").text((integer / 1000) + ' kW');

                            if (integer > 1600) {
                                $('#wasmasjien').show();
                            } else {
                                $('#wasmasjien').hide();
                            }
                            if (integer > 2200) {
                                $('#skottelgoed').show();
                                $('#oond').show();
                            } else {
                                $('#skottelgoed').hide();
                                $('#oond').hide();
                            }
                            if (integer > 4000) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon HIGH");
                                airconThresholdBreachCounter = 0;
                            } else if (integer > 3000) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon MEDIUM");
                                airconThresholdBreachCounter = 0;
                            } else if (integer > 2100) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon LOW");
                                airconThresholdBreachCounter = 0;
                            } else if (integer > 1500) {
                                checkAndSendAirconThresholdNotification(integer);
                                airconThresholdBreachCounter ++;
                                $('#aircon').show();
                                $('#aircon').text("Aircon FAN ONLY");
                            } else {
                                $('#aircon').hide();
                            }

                        } else {
                            checkAndSendAirconThresholdNotification(integer);
                            $("#powerGen").text(integer + ' w');
                            if(integer == 0){

                                if(new Date().getHours() >= 22){
                                    $('#body').hide();
                                    $('html').on('click', function(){$('#body').show();});
                                }
                                
                                timeout = 600000; // 10 mins;
                            }else{
                                $('#body').show();
                                $('html').on('click', function(){});
                                timeout = 6000; // 6 seconds
                            }
                        }

                        var gaugeVal = ((integer / 1000)/5*100).toFixed(2);
                        gauge.refresh(gaugeVal);
                        setGauge(gaugeVal);
                        
                        if(gaugeVal>0){
                            $('#percentage').text(gaugeVal+"%");
                        }else{
                            $('#percentage').text("0%");
                        }
                    
                        var kWhTotalGenerated = obj.Body.DAY_ENERGY.Values["1"] / 1000;
                        $("#powerTotal").text((kWhTotalGenerated) + " kWh");

                        
                        var powerTotalText = $("#powerTotal").text();
                        
                        var recordGenerated = getRecordPowerGeneratedForNow(integer);
                        if(recordGenerated){
                            recordGenerated = recordGenerated.replace('kWh','');
                            if(kWhTotalGenerated > recordGenerated){
                                if(!newHighAlertSent){
                                    newHighAlertSent = true;
                                    sendNotification("Fronius", "New highest daily record!");
                                }
                                $("#powerTotal").html(powerTotalText + ' <span class="newRecord">(+' + (kWhTotalGenerated - recordGenerated).toFixed(2) + ' kWh)</span>');
                            }else{
                                $("#powerTotal").html(powerTotalText + ' <span class="noRecord">(-' + (recordGenerated -  kWhTotalGenerated).toFixed(2) + ' kWh)</span>');
                            }
                        }
                        

                        setTimeout(function () { load(); }, timeout);
                    });
                }catch(ex){
                    setTimeout(function () { load(); }, timeout);
                }
            }

        });

        var mode = "NORMAL";
        function setGauge(value){
            if(value > 100 && mode !== "MAXIMUS"){
                console.log("maxi");
                mode = "MAXIMUS"
                gauge = new JustGage({
                    id: "gauge", // the id of the html element
                    value: value,
                    min: 0,
                    max: 100,
                    decimals: 2,
                    levelColors: ["#ff0000", "#f9c802", "#a9d70b", "#0083d6"],
                    gaugeWidthScale: 0.6
                });
            }else if(value <= 100 && mode !== "NORMAL"){
                console.log("normal");
                mode = "NORMAL";
                gauge = new JustGage({
                    id: "gauge", // the id of the html element
                    value: value,
                    min: 0,
                    max: 100,
                    decimals: 2,
                    levelColors: ["#ff0000", "#f9c802", "#00b800"],
                    gaugeWidthScale: 0.6
                });
            }else{
                gauge.refresh(value);
            }
            
        }

        function getRecordPowerGeneratedForNow(powerGenCurrent){
            if(recordData === undefined){
                console.log('recordData not loaded');
                return;
            }

            if(powerGenCurrent == 0){
                return recordData[0][2];
            }

            var now = new Date();
            var closest5Min = Math.ceil(now.getMinutes()/5)*5;
            now.setMinutes(closest5Min);
            var key = formatAMPM(now);

            for (var i = 0; i < recordData.length; i++) {
                var obj = recordData[i];
                if(obj[1] === key){
                    return obj[2];
                }
            }

            return null;
           
            //return recordData.find(x => x[1] === key) !== undefined ? recordData.find(x => x[1] === key)[2] : null;
        }
        
        

        function formatAMPM(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0'+minutes : minutes;
            var strTime = hours + ':' + minutes + '' + ampm;
            return strTime;
        }

        function sendNotification(title, message){
            if(!queryString["key"]){
                return;
            }
            if(notificationCounter > maxNotifications){
                return;
            }else if(notificationCounter == maxNotifications){
                title = "MAX NOTIFICATIONS REACHED! - " + title;
            }

            var userKey =  queryString["key"];
            var data = {
                "token": "a5bp7hm1aosnsj3nthoozw75jsdhf9",
                "user": userKey,
                "title": title,
                "message": message
            };

            $.ajax({
                type: "POST",
                url: "https://api.pushover.net/1/messages.json",
                data: data,
                success: function(){},
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                dataType: 'json',
                success: function (response) {
                    notificationCounter++;
                    return response;
                }
            });
        }

        function changeTab(mode){
            $('li.tab').removeClass('active');
            $('#pvOutputIframe').attr('src','');
            $('div.section').hide();
            if(mode === 'home'){
                $('#homeSection').show();
                $('#home').addClass('active');
                
            }else if(mode === 'settings'){
                $('#settingsSection').show();
                $('#settings').addClass('active');
            }else{
                $('#pvOutputIframe').hide();
                $('#pvOutputSection').show();
                
                if(mode === 'pvOutput'){
                    $('#pvOutput').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/intraday.jsp?id=84198&sid=74658');
                }
                else if(mode === 'pvOutputRecord'){
                    $('#pvOutputRecord').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/intraday.jsp?id=84198&sid=74658&dt=20200409&gs=0&m=0');
                }    
                else if(mode === 'pvOutputDaily'){
                    $('#pvOutputDaily').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/list.jsp?id=84198&sid=74658');
                }
                else if(mode === 'savings'){
                    $('#savings').addClass('active');
                    $('#pvOutputIframe').attr('src', 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3adaAnQqZe2ir_9gZRnGzKk4s-VPEliTOyJjUjNOlPlM6wzN2a3jOE8XqHyrXS_f9AHECmNqhWb8_/pubchart?oid=1336524382&amp;format=interactive');
                }

                $('#pvOutputIframe').show();
                    
            }
        }
    </script>
</body>

</html>