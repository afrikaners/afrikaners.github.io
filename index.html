<!DOCTYPE html>
<html>

<head>
    <meta name="mobile-web-app-capable" content="yes">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> -->
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
           
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
        integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="raphael.min.js"></script>
    <script type="text/javascript" src="justgage.min.js"></script>
    <script type="text/javascript" src="nosleep.js"></script>
    <script type="text/javascript" src="papaparse.js"></script>
    <!-- <script type="text/javascript" src="jquery.csv.min.js"></script>  -->
    
    <style>
        body {
            background-color: #22252a;
            color: white;
        }
        html{
            background-color: #22252a;
        }
        
        h3{
            margin-top: 0;
        }

        svg text{display:none;}

        .widgetBlock-left, .widgetBlock-bottom-left {
            background-color: #2d3035;
            height: 100%;
            min-height: 220px;
            margin-left: 25px;
            padding: 15px;
        }

        .widgetBlock-bottom-left{
            margin-top:25px;
        }

        .widgetBlock-right, .widgetBlock-bottom-right{
            background-color: #2d3035;
            height: 100%;
            min-height: 220px;
            margin-right: 25px;
            padding: 15px;
        }

        .widgetBlock-bottom-right{
            margin-top:25px;
        }

        .no-padding{
           /* padding: 0 !important;
           margin: 0 !important;*/
        }

        .green {
            color: lightgreen;
        }

        .newRecord{
            font-size: smaller;
            color:green;
        }
        .noRecord{
            font-size: smaller;
            color:red;
        }
        #dayEnd_Error{
            color:red;
            font-size: bigger;
            font-weight: 800;
        }

        .progress-bar-danger{
            background-color:lime !important;
        }

        .progress {
            height:30px;
        }

        #powerTotal{
            position:absolute;
            top: 38px;
            left: 25px;
            color:black;
        }
        #powerTotalFromRecord{
            position:absolute;
            top: 65px;
            color:black;
        }

        #overGenerated, #estimateLiveCost{
            position:absolute;
            color:black;
            right:20px;
            top:61px;
        }

        #estimateLiveCost{
            color:white;
            top:63px;
            
        }

        .setting-buttons input{
            background-color: black;
            height: 50px;
            color: white;
            width: 220px;
            margin-left: 25px;
        }

        .navbar-inverse {
            background-color: #2d3035 !important;
        }
        .navbar-inverse .navbar-nav>.active>a, .navbar-inverse .navbar-nav>.active>a:focus, .navbar-inverse .navbar-nav>.active>a:hover{
            background-color: #22252a;
        }
    </style>
</head>

<body id="body">
    <div class="container-fluid" style="padding:0;">
       
        <nav class="navbar navbar-inverse navbar-static-top">
            <div class="container">
                <ul class="nav navbar-nav">
                    <li id="home" class="active tab" onclick="changeTab('home');"><a href="#">Home</a></li>
                    <li id="weather" class="tab"><a href="#" onclick="changeTab('weather');">Weather</a></li>
                    <li id="pvOutput" class="tab"><a href="#" onclick="changeTab('pvOutput');">PV Output</a></li>
                    <li id="pvOutputRecord" class="tab"><a href="#" onclick="changeTab('pvOutputRecord');">PVO Record</a></li>
                    <li id="pvOutputDaily" class="tab"><a href="#" onclick="changeTab('pvOutputDaily');">PVO Daily</a></li>
                    <li id="savings" class="tab"><a href="#" onclick="changeTab('savings');">Savings</a></li>
                    <li id="settings" class="tab"><a href="#" onclick="changeTab('settings');">Settings</a></li>
                  </ul>
            </div>
          </nav>

        <div id="homeSection" class="row section">
            <div id="busyHours" class="col-md-6 col-sm-6">
                    <div class="no-padding widgetBlock-left">
                        <div class="row">
                            <div class="col-xs-6"><h3>Realtime Data:</h3></div>
                        </div>
                        <div class="row" >
                            <!-- <div class="col-xs-12" style="height:155px;overflow:hidden;">
                                <div style="width:430px;height:175px;overflow:hidden;" id="gauge"></div>
                                <div style="width:100%;text-align:left;position:absolute; top: 20px; left:160px">
                                    <h2 style="top:60px;left:10px;position:absolute;" id="powerGen">Loading...</h2>
                                    <h4 style="position:absolute;top:10px;left:40px;" id="percentage"></h4>
                                </div>
                            </div> -->
                            <div class="col-xs-12" style="position:absolute;text-align: center; align-content: center;">
                                <div style="width:430px;height:175px;overflow: hidden;margin:auto;" id="gauge"></div>
                                
                                    <h2 style="position:relative; top: -90px;" id="powerGen">Loading...</h2>
                                    <h4 style="position:relative;top:-190px;" id="percentage"></h4>
                                
                            </div>
                           
                        </div>
                    </div>
                  
                    <div class="widgetBlock-bottom-left">
                        <div class="row">
                            <div class="col-xs-12" style="text-align: center;vertical-align: middle;">
                                <h1 id="skottelgoed" style="display:none" class="green">Skottelgoed Wasser</h1>
                                <h1 id="oond" style="display:none" class="green">Oond</h1>
                                <h1 id="wasmasjien" style="display:none" class="green">Wasmasjien</h1>
                                <h1 id="aircon" style="display:none" class="green">Aircon</h1>
                                <h2 id="nada" style="display:none; color:#eb8b88">Te min energie</h2>
                            </div>
                        </div>
                    </div>
            </div>
            <div id="afterhours" class="col-md-6 col-sm-6" style="display:none">
                    <div class="no-padding widgetBlock-left">
                        <div class="row">
                            <div class="col-xs-12" style="text-align: center;">
                                <h2 id="nightCurrentConsumption">0 kWh</h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6" style="text-align: center;">
                                <h3>Generated Today</h3>
                            </div>
                            <div class="col-xs-6" style="text-align: center;">
                                <h3>Expected Daily</h3   >
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-6" style="text-align: center;">
                                <h3 id="dayEnd_TotalGenerated"></h3>
                            </div>
                            <div class="col-xs-6" style="text-align: center;">
                                <h3 id="dayEnd_MonthExpected"></h3>
                                <h3 id="dayEnd_Error" style="display:none;"></h3>
                            </div>
                        </div>
                        <div id="actualStats" class="row">
                            <div class="col-xs-12">
                                <div class="row">
                                    <div class="col-xs-12" style="text-align: center">
                                        <h2>Stats For Today</h2>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Overall Saving today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="totalSavedToday"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                      &nbsp;
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Syn Bill impact of Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="synergyImpact"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Units Fed In Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="unitsFedInToday"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Feed In Pay Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="feedInPayToday"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Grid Units Used Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="gridUnitsUsedToday"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Grid Used Cost Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="gridUsedCost"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Solar Units Used Today</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="solarUnitsUsedToday"></h4>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-6">
                                        <h4>Solar Used Savings</h4>
                                    </div>
                                    <div class="col-xs-6">
                                        <h4 id="solarUsedSavings"></h4>
                                    </div>
                                </div>
                               
                                
                                
                               
                            </div>
                        </div>     
                    </div>
            </div>
            <div class="col-md-6 col-sm-6">
                    <div class="no-padding widgetBlock-right">
                        <div class="col-xs-12">
                            <div class="row" style="text-align: center;">
                                <div class="col-xs-6">
                                    <img id="consumingFromGrid" src="right.png" style="display:none;width:150px"/>
                                    <img id="exportingToGrid" src="left.png" style="display:none;width:150px"/>
                                 
                                </div>
                                <div class="col-xs-6">
                                       <img  src="grid.png"/>
                                </div>
                            </div>
                            <div class="row" id="feedIn" style="display:none" style="text-align: center;">
                                <div class="col-xs-6" style="text-align:center">
                                    <h4 >Feed In</h4>
                                </div>
                                <div class="col-xs-6" style="text-align: center">
                                    <h4 class="green" id="currentFeedIn"></h4>
                                </div>
                            </div>
                            <div class="row" style="text-align: center;">
                                <div class="col-xs-6" style="text-align:center">
                                    <h4>Consumption</h4>
                                </div>
                                <div class="col-xs-6" style="text-align: center">
                                    <h4 id="currentConsumption"></h4>
                                </div>
                            </div>
                            
                            <div class="row" id="pullingFromGrid" style="display:none;text-align: center;">
                                <div class="col-xs-6">
                                    <h4>Grid Use</h4>
                                </div>
                                <div  class="col-xs-6">
                                    <h4 style="color:red" id="currentPullFromGrid"></h4>
                                </div>
                            </div>
                        </div>
                       
                    </div>

                    <div id="totalForTodayBlock" class="widgetBlock-bottom-right">
                        <div  class="row">
                            <div class="col-xs-12">
                                <h3>Total for today:</h3>
                                <p id="overGenerated" style="display:none"></p>
                                <h3 id="powerTotal"></h3>
                                <h3 id="powerTotalFromRecord"></h3>
                                <h3 id="estimateLiveCost"></h3>
                                <div class="progress">
                                    <div id="progressStandard" class="progress-bar progress-bar-success progress-bar-striped active" style="width: 1%">
                                    </div>
                                    <div id="progressBeyond" style="display:none" class="progress-bar progress-bar-danger progress-bar-striped active" style="width: 1%">
                                    </div>
                                  </div>
                            </div>
                        </div>
                        <div class="row" id="airconStatus" style="display:none">
                            <div class="col-xs-12">
                                <p style="color:green">Aircon is aan.</p>
                            </div>
                        </div>
                        <div id="solarMeterData" style="display:none;">
                            <div class="row">&nbsp;</div>
                            <div class="row" >
                                <div class="col-xs-3">
                                <h5>Fed In</h5>
                                </div>
                                <div class="col-xs-3">  
                                    <h5 id="actualUnitsFedIn"></h5>
                                </div>
                                <div class="col-xs-3">
                                    <h5>Grid Units</h5>
                                </div>
                                <div class="col-xs-3">
                                <h5 id="totalImportToday"></h5>
                                </div>
                            </div>
                            <div class="row" >
                                <div class="col-xs-3">
                                    <h5>Solar Units</h5>
                                </div>
                                <div class="col-xs-3">
                                <h5 id="solarUnitsConsumed"></h5>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <div id="pvOutputSection" style="display:none;" class="row section">
            <div id="pvOutputDiv" class="col-xs-12">
                <iframe id="pvOutputIframe" style="display: block;" src="" width="1024" height="4000" frameborder="0"  scrolling="no"></iframe>
            </div>
            <div id="Weather" class="col-xs-12" style="display:none">
                <!--<div style="width: 450px;"><iframe id="weatherWidget" style="display: block;" src="https://cdnres.willyweather.com.au/widget/loadView.html?id=57209" width="450" height="520" frameborder="0"  scrolling="no"></iframe><a style="margin: -20px 0 0 0;position: relative;text-indent: -9999em;z-index: 1;height: 20px;display: block" href="https://www.willyweather.com.au/wa/perth/yanchep.html" rel="nofollow">Yanchep Forecast</a></div>-->
                <div style="width: 1000px;"><iframe  id="weatherWidget" style="display: block;" src="https://cdnres.willyweather.com.au/widget/loadView.html?id=57699" width="1000" height="520" frameborder="0"  scrolling="no"></iframe><a style="text-indent: -9999em;z-index: 1;margin: -20px 0 0 0;display: block;height: 20px;position: relative" href="https://www.willyweather.com.au/wa/perth/yanchep.html" rel="nofollow">https://www.willyweather.com.au/wa/perth/yanchep.html</a></div>
            </div>
        </div>
        <div id="savingsSection" style="display:none;" class="row section">
            <div class="col-xs-12">
               <img style="width:1024px" id="graphImage" src=""/>
            </div>
        </div>
        <div id="settingsSection" style="display:none;" class="row section">
            <div class="col-xs-12 setting-buttons">
                <div class="row">
                    <div class="col-xs-12 ">
                        <input type="button" id="toggle" value="Wake Lock is disabled" /><br/><br/>
                        <input type="button" id="notifyAircon" value="Notify Aircon Threshold: false" /><br/><br/>
                        <input type="button" id="monitorAirconStatus" value="Monitor Aircon Status: true" /><br/><br/>
                        <input type="button" id="forceAfterhoursStats" value="After Hours Stats Forced: false" /><br/><br/>
                        <input type="button" id="forcePvOutputUpdate" value="Force PV Output Update" /><br/><br/>
                        <input type="button" id="notifyIfUsingGrid" value="Notify if using Grid Energy: false" /><br/><br/>
                        <div id="error"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    

    
    <script>
        var gauge;
        var recordData;

        var queryString = new Array();
        var newHighAlertSent = false;
        var notifyAirconThreshold = false;
        var airconThresholdBreachCounter = 0;
        var monitorAirconStatus = 1;
        var maxNotifications = 20;
        var notificationCounter = 0;
        var timeout = 6000;

        var medsReminderSent = false;
        var allMedsAlertsSent = false;
        var medsAlertSent8pm = false;
        var medsAlertSent9pm = false;
        var medsAlertSent10pm = false;
        var firstLoad = true;

        var feedInKwhPay = 0.07135;
        var gridKwhPrice = 0.262026;
        var avgDailyGridUse = 4.384615385;
        var avgDailySolarUse = 3.168423684;
        var todaySolarUseActual, todayGridUseActual, dateLastLogged, totalGridUseActual, totalFeedInActual, todayGeneratedActual, todayTotalUsedActual;
        var currentRealtimeConsumption;
        var currentRealtimeGridFeedIn;
        var feedingIntoGrid;
        var medsTaken = false;
        var forceAfterHours = false;
        var notifyIfUsingGridEngergyDuringDay = false;
        var finalDayNotificationSent = false;
        var nextGridUseAlertTime;

        var airconMonthEstimates = new Array();
        airconMonthEstimates[0] = 40.9;
        airconMonthEstimates[1] = 37.4;
        airconMonthEstimates[2] = 32.6;
        airconMonthEstimates[3] = 29;
        airconMonthEstimates[4] = 20.3;
        airconMonthEstimates[5] = 18.4;
        airconMonthEstimates[6] = 19.7;
        airconMonthEstimates[7] = 22.6;
        airconMonthEstimates[8] = 28.1;
        airconMonthEstimates[9] = 33.8;
        airconMonthEstimates[10] = 35.3;
        airconMonthEstimates[11] = 38.8 ;


        try{
            Papa.parse("https://afrikaners.github.io/record.csv", {
                download: true,
                complete: function(results) {
                    recordData = results.data;
                }
            });
        }catch(ex){
            console.log(ex);
        }

        $(document).ready(function () {
           
            try{

                if (queryString.length == 0) {
                    if (window.location.search.split('?').length > 1) {
                        var params = window.location.search.split('?')[1].split('&');
                        for (var i = 0; i < params.length; i++) {
                            var key = params[i].split('=')[0];
                            var value = decodeURIComponent(params[i].split('=')[1]);
                            queryString[key] = value;
                        }
                    }
                }

                loadPVOutputData(false);

                $('#notifyAircon').click(function(){
                    notifyAirconThreshold = !notifyAirconThreshold;
                    $('#notifyAircon').attr('value', 'Notify Aircon Threshold: ' + notifyAirconThreshold);
                });

                $('#monitorAirconStatus').click(function(){
                    monitorAirconStatus = !monitorAirconStatus;
                    $('#monitorAirconStatus').attr('value', 'Monitor Aircon Status: ' + monitorAirconStatus);
                    if(monitorAirconStatus)
                        setTimeout(airconStatus, timeout);
                    else
                        $("#airconStatus").hide();
                });

                $('#forceAfterhoursStats').click(function(){
                    forceAfterHours = !forceAfterHours;
                    $('#forceAfterhoursStats').attr('value', 'After Hours Stats Forced: ' + forceAfterHours);
                });

                $('#forcePvOutputUpdate').click(function(){
                    loadPVOutputData(true);
                });

                $('#notifyIfUsingGrid').click(function(){
                    notifyIfUsingGridEngergyDuringDay = !notifyIfUsingGridEngergyDuringDay;
                    $('#notifyIfUsingGrid').attr('value', 'Notify if using Grid Energy: ' + notifyIfUsingGridEngergyDuringDay);
                });

                load();
                //loadWeather();
                airconStatus();

                var noSleep = new NoSleep();
                var wakeLockEnabled = false;
                var toggleEl = document.querySelector("#toggle");

                toggleEl.addEventListener('click', function () {
                    if (!wakeLockEnabled) {
                        noSleep.enable(); // keep the screen on!
                        wakeLockEnabled = true;
                        toggleEl.value = "Wake Lock is enabled";
                        //document.getElementById("toggle").style.display = "none";
                        //document.body.style.backgroundColor = "green";
                    } else {
                        noSleep.disable(); // let the screen turn off.
                        wakeLockEnabled = false;
                        toggleEl.value = "Wake Lock is disabled";
                        //document.body.style.backgroundColor = "";
                    }
                }, false);

                try{
                    gauge = new JustGage({
                            id: "gauge", // the id of the html element
                            value: 0,
                            min: 0,
                            max: 100,
                            decimals: 2,
                            levelColors: ["#ff0000", "#f9c802", "#00b800"],
                            gaugeWidthScale: 0.6
                        });
                        //gauge.refresh(24);
                }catch(ex){
                    $('#error').text(ex.message);
                }

            }catch(ex){
                alert(ex.message);
            }

            

            function checkAndSendAirconThresholdNotification(powerGenLevel){
                if(notifyAirconThreshold && airconThresholdBreachCounter == 4){
                    notifyAirconThreshold = false; 
                    airconThresholdBreachCounter = 0;
                    $('#notifyAircon').attr('value', 'Notify Aircon Threshold: ' + notifyAirconThreshold);
                    sendNotification("Aircon Threshold alert", "Solar below Aircon ON threshold. (" + powerGenLevel + " w)");
                }else if(notifyAirconThreshold){
                    airconThresholdBreachCounter ++;
                }
            }

            function airconStatus(){
                if(!monitorAirconStatus)
                    return;

                if(new Date().getHours() > 18 || new Date().getHours()< 7){
                    return;
                }

                $.get("https://valuehold2.apphb.com/api/aircon", function (data) {
                    if(data === "ON")
                        $("#airconStatus").show();
                    else
                        $("#airconStatus").hide();

                    setTimeout(airconStatus, timeout);
                });
            }

            function resetFlags(){
                oldkWhMax = 0;
                medsReminderSent = false;
                allMedsAlertsSent = false;
                medsAlertSent8pm = false;
                medsAlertSent9pm = false;
                medsAlertSent10pm = false;
                medsTaken = false;
                notificationCounter = 0;
                finalDayNotificationSent = false;
            }

            function checkAlerts(){
                var nowHour = new Date().getHours();

                if(nowHour  === 0){
                    resetFlags();
                    //loadSolarBaseSettings();
                }else if(firstLoad){
                    //loadSolarBaseSettings();
                }

                //10am reminder if meds not taken yet.
                if(nowHour  === 10)
                    checkAndSendAmMedsReminder();
                

                //8pm, 9pm & 10pm reminder if meds still not taken.
                if(nowHour === 20 || nowHour  === 21 || nowHour  === 22)
                    checkAndSendPmMedsAlert(nowHour);

            }

            function checkAndSendAmMedsReminder(){
                if(medsTaken || medsReminderSent)
                    return;

                $.get("https://valuehold2.apphb.com/api/meds", function (data) {
                    if(data === false){
                        medsReminderSent = true;
                        sendNotification('Meds', "Boet, onthou jou medisyne!");
                    }else{
                        medsTaken = true;
                    }
                });
            }

            function checkAndSendPmMedsAlert(nowHour){
                if(medsTaken || allMedsAlertsSent)
                    return;

                if(!(nowHour === 20 || nowHour === 21 || nowHour === 22 ))
                    return;

                if(nowHour === 20 && medsAlertSent8pm){
                    return;
                } else if(nowHour === 21 && medsAlertSent9pm){
                    return;
                } else if(nowHour === 22 && medsAlertSent10pm){
                    return;
                }

                $.get("https://valuehold2.apphb.com/api/meds", function (data) {
                    if(data === false){

                        sendNotification('Meds', "Boet, Drink jou medisyne!");
                        
                        if(nowHour === 20)
                            medsAlertSent8pm = true;
                        if(nowHour === 21)
                            medsAlertSent9pm = true;
                        if(nowHour === 22)
                            medsAlertSent10pm = true;

                        allMedsAlertsSent = medsAlertSent8pm && medsAlertSent9pm && medsAlertSent10pm;
                    }else{
                        medsTaken = true;
                    }
                });

            }

            function loadSolarFlowData(){

                if((new Date().getHours() >= 18 && new Date().getHours() <= 23) || (new Date().getHours() >= 5 && new Date().getHours() < 7)){
                    setTimeout(function () { loadSolarFlowData(); }, 6000);
                }

                return $.get("https://valuehold2.apphb.com/api/solarflowdata",function(data){
                            var dataString = JSON.stringify(data);
                            //console.log(dataString);
                            dataString = dataString.replace(/\\n/g, "");
                            dataString = dataString.replace(/\\/g, "");
                            dataString = dataString.replace(/ /g, '');
                            dataString = dataString.substring(1);
                            dataString = dataString.substring(0, dataString.length - 1);

                            var obj = JSON.parse(dataString);
                            currentRealtimeConsumption = obj.Body.Site.P_Load;
                            currentRealtimeGridFeedIn = obj.Body.Site.P_Grid;

                            feedingIntoGrid = currentRealtimeGridFeedIn < 0;
                        
                            
                            if(currentRealtimeConsumption < 0){
                                if(currentRealtimeConsumption < -1000){
                                    $('#currentConsumption').text(Math.abs((currentRealtimeConsumption/1000)).toFixed(2) + " kW");
                                }else{
                                    $('#currentConsumption').text(Math.abs(currentRealtimeConsumption).toFixed(2) + " W");
                                }
                            }else{
                                $('#currentConsumption').text("0 W");
                            }

                            if(feedingIntoGrid){
                                $("#feedIn").show();
                                $("#pullingFromGrid").hide();
                                currentRealtimeGridFeedIn = Math.abs(currentRealtimeGridFeedIn);
                                if(currentRealtimeGridFeedIn > 1000){
                                    $('#currentFeedIn').text((currentRealtimeGridFeedIn/1000).toFixed(2) + " kW");
                                }else{
                                    $('#currentFeedIn').text(currentRealtimeGridFeedIn.toFixed(2) + " W");
                                }
                            }else{
                                $('#currentFeedIn').text("0 W");
                                $("#feedIn").hide();
                                $("#pullingFromGrid").show();

                                if(currentRealtimeGridFeedIn > 1000){
                                    $('#currentPullFromGrid').text((currentRealtimeGridFeedIn/1000).toFixed(2) + " kW"); 
                                }else{
                                    $('#currentPullFromGrid').text(currentRealtimeGridFeedIn.toFixed(2) + " W");
                                }
                                $('#nightCurrentConsumption').text( $('#currentPullFromGrid').text());

                            }

                            if(feedingIntoGrid){
                                $('#exportingToGrid').hide();
                                $('#consumingFromGrid').show();
                                
                            }else{
                                $('#exportingToGrid').show();
                                $('#consumingFromGrid').hide();

                                if(notifyIfUsingGridEngergyDuringDay && (new Date().getHours() >= 10 && new Date().getHours() <= 16)){
                                    if(nextGridUseAlertTime == undefined || new Date() >= nextGridUseAlertTime){
                                        sendNotification('Using Grid Energy!', 'Started using grid energy when we should not be.');
                                        nextGridUseAlertTime = addMinutes(new Date(),30);
                                    }
                                }
                            }

                    });
            }

            function addMinutes(date, minutes) {
                return new Date(date.getTime() + minutes*60000);
            }

            function load() {
                
                try{

                    checkAlerts();
                    loadSolarFlowData().done(loadTheRest).fail(failedLoading);
                   
                }catch(ex){
                    console.log('exception');
                    setTimeout(function () { load(); }, timeout);
                }
            }
           
            function loadTheRest(){

                $.get("https://valuehold2.apphb.com/api/values", function (data) {
                    // alert( "Data Loaded: " +  );
                    var dataString = JSON.stringify(data);
                    //console.log(dataString);
                    dataString = dataString.replace(/\\n/g, "");
                    dataString = dataString.replace(/\\/g, "");
                    dataString = dataString.replace(/ /g, '');
                    dataString = dataString.substring(1);
                    dataString = dataString.substring(0, dataString.length - 1);

                    if(dataString !== 'NoData'){
                        var obj = JSON.parse(dataString);
                        var powerGenVal = obj.Body.PAC.Values["1"];
                        var integer = parseInt(powerGenVal, 10);

                        if(forceAfterHours || integer == 0 && (new Date().getHours() >= 18 || new Date().getHours() < 7)){
                        //if(false){
                            $('#afterhours').show();
                            $('#totalForTodayBlock').hide();
                            $('#solarMeterData').hide();
                            //$('#afterhours').hide();
                            $('#busyHours').hide();
                            $('#dayEnd_Error').hide();
                            //loadSolarBaseSettings(true);
                        }else{
                            $('#afterhours').hide();
                            $('#totalForTodayBlock').show();
                            if($('#estimateLiveCost').is(':visible')){
                                $('#solarMeterData').show();
                            }else{
                                $('#solarMeterData').hide();
                            }
                            
                            $('#busyHours').show();
                           
                        }

                        var remainingKw = 0;
                        if(feedingIntoGrid){
                            remainingKw = currentRealtimeGridFeedIn;
                        }
                        
                        if (remainingKw > 1000) {
                            $('#nada').hide();
                            $("#powerGen").text((integer / 1000) + ' kW');

                            if (remainingKw > 1600) {
                                $('#wasmasjien').show();
                            } else {
                                $('#wasmasjien').hide();
                            }
                            if (remainingKw > 2900) {
                                $('#skottelgoed').show();
                                $('#oond').show();
                            } else {
                                $('#skottelgoed').hide();
                                $('#oond').hide();
                            }
                            if (remainingKw > 4000) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon HIGH");
                                airconThresholdBreachCounter = 0;
                            } else if (remainingKw > 3000) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon MEDIUM");
                                airconThresholdBreachCounter = 0;
                            } else if (remainingKw > 2100) {
                                $('#aircon').show();
                                $('#aircon').text("Aircon LOW");
                                airconThresholdBreachCounter = 0;
                            } else if (remainingKw > 1500) {
                                checkAndSendAirconThresholdNotification(remainingKw);
                                airconThresholdBreachCounter ++;
                                $('#aircon').show();
                                $('#aircon').text("Aircon FAN ONLY");
                            } else {
                                $('#aircon').hide();
                            }
                        } else {
                            checkAndSendAirconThresholdNotification(integer);
                            $("#powerGen").text(integer + ' w');
                            $('#nada').show();
                            if(integer == 0){
                                /*if(new Date().getHours() >= 20 || new Date().getHours() < 7){
                                    $('#body').hide();
                                    $('html').on('click', function(){$('#body').show();});
                                }*/
                                $("#powerGen").text('0.00 w');
                                timeout = 600000; // 10 mins;
                            }else{
                                $('#body').show();
                                $('html').on('click', function(){});
                                $('#afterhours').hide();
                                $('#solarMeterData').show();
                                $('#busyHours').show();
                                timeout = 6000; // 6 seconds
                            }
                        }

                        var gaugeVal = ((integer / 1000)/5*100).toFixed(2);
                        gauge.refresh(gaugeVal);
                        setGauge(gaugeVal);
                        
                        if(gaugeVal>0){
                            $('#percentage').text(gaugeVal+"%");
                        }else{
                            $('#percentage').text("0%");
                        }
                    
                        var kWhTotalGenerated = obj.Body.DAY_ENERGY.Values["1"] / 1000;

                        setProgress(kWhTotalGenerated, true);
                        ////$("#powerTotal").text((kWhTotalGenerated) + " kWh");
                        $("#dayEnd_TotalGenerated").text($('#powerTotal').text());
                        $('#dayEnd_MonthExpected').text(monthExpected + ' kWh');
                        $('#stats').show();
                        
                        //setEstimatePricingValues(kWhTotalGenerated);
                        

                        if(kWhTotalGenerated <= monthExpected){
                            $("#dayEnd_TotalGenerated").attr('style', 'color:red');
                        }else{
                            $("#dayEnd_TotalGenerated").attr('style', 'color:green');
                        }
                        
                        //var powerTotalText = $("#powerTotal").text();
                        ////loadMeterData(kWhTotalGenerated);
                        var recordGenerated = getRecordPowerGeneratedForNow(integer);
                        if(recordGenerated){
                            recordGenerated = recordGenerated.replace('kWh','');
                            var now = new Date();
                            //don't trigger before 4pm.
                            if(now.getHours() >= 16 && kWhTotalGenerated > recordGenerated){
                                if(!newHighAlertSent){
                                    newHighAlertSent = true;
                                    sendNotification("Fronius", "New highest daily record!");
                                }
                                $("#powerTotalFromRecord").html('<span class="newRecord">(+' + (kWhTotalGenerated - recordGenerated).toFixed(2) + ' kWh)</span>');
                            }else{
                                $("#powerTotalFromRecord").html('<span class="noRecord">(' + (recordGenerated -  kWhTotalGenerated).toFixed(2) + ' kWh)</span>');
                            }
                        }
                    }else{
                        //api server data got cleared. Temp error state
                        $('#afterhours').show();
                        $('#solarMeterData').hide();
                        $('#dayEnd_Error').hide();
                        $('#stats').hide();
                        $('#busyHours').hide();
                        $("#dayEnd_TotalGenerated").text("Error loading data from Server...");
                        $('#dayEnd_MonthExpected').text('');

                        if(new Date().getHours() >= 21){
                            $('#body').hide();
                            $('html').on('click', function(){$('#body').show();});
                        }

                        timeout = 600000; // 10 mins;
                    }
                    firstLoad = false; 
                    
                    setTimeout(function () { load(); }, timeout);
                })
                .fail(failedLoading);

            }

            function loadPVOutputData(forceUpdate){
                console.log("loadPVOutputData called");
                if(!queryString["pvkey"]){
                    $('#actualStats').hide();
                    $('#estimateLiveCost').hide();
                    $('#solarMeterData').hide();
                   
                    return;
                }
                
                var today = new Date();
                var nowHour = today.getHours();

                if(!forceUpdate){
                    if(nowHour < 6 || nowHour > 23){
                        $('#actualStats').hide();
                        return;
                    }
                }else{
                    $('#actualStats').show();
                }
                
                var month = today.getMonth()+1;
                if(month < 10){
                    month = "0"+month;
                }
                month=month.toString();
                var day = today.getDate();
                if(day < 10){
                    day = "0"+day;
                }
                day = day.toString();
                var dateFilter = today.getFullYear()+month+day;
                var url = "https://valuehold2.apphb.com/api/pvoutputdata?key=" + queryString["pvkey"] + "&df=" + dateFilter + "&dt="+dateFilter;
                //console.log(url);
                //var data = "28600,24138,28600,28600,28600,4.301,1,20200509,20200509,4.301,20200509,7236,2774,0,0,0,7236,7236,7236";
                $.get(url,function(data){
                    var array = data.split(',');
                    var totalGenerated = array[0];
                    var totalExport = array[1];
                    var totalSolarUsed = totalGenerated - totalExport;
                    var totalConsumed = array[11];
                    var totalImport = totalConsumed - totalSolarUsed;
                    //console.clear();
                    /*console.log("totalGenerated: " + totalGenerated);
                    console.log("totalExport: " + totalExport);
                    console.log("totalConsumed: " + totalConsumed);
                    console.log("totalSolarUsed: " + totalSolarUsed);
                    console.log("totalImport: " + totalImport);
                    console.log(" ");*/

                    if(totalImport > 1000){
                        $('#gridUnitsUsedToday').text((totalImport/1000).toFixed(2) + " kWh");
                    }else{
                        $('#gridUnitsUsedToday').text((totalImport).toFixed(2) + " Wh");
                    }

                    var todayImportCost = (totalImport/1000) * gridKwhPrice;
                    $('#gridUsedCost').text('$ '+ todayImportCost.toFixed(2));

                    if(totalImport >= 1000)
                        $('#totalImportToday').text((totalImport/1000).toFixed(2) + " kWh");
                    else
                        $('#totalImportToday').text((totalImport).toFixed(2) + " Wh");

                    if(totalGenerated === 0){
                        $("#solarUnitsConsumed").text("0 kWh");
                        $('#solarUnitsUsedToday').text($("#solarUnitsConsumed").text());
                        $('#solarUsedSavings').text('$ 0');
                        $('#feedInPayToday').text('$ 0');
                        $('#totalSavedToday').text('$ 0');
                        $('#synergyImpact').text('$ 0');
                        $('#unitsFedInToday').text('0');
                    }else{

                        if(totalExport > 1000){
                            $('#actualUnitsFedIn').text((totalExport/1000).toFixed(2) + " kWh");
                        
                        }else{
                            $('#actualUnitsFedIn').text(totalExport + " Wh");
                        }

                        $('#unitsFedInToday').text($('#actualUnitsFedIn').text());
                        
                        if(totalSolarUsed > 1000){
                            $("#solarUnitsConsumed").text((totalSolarUsed/1000).toFixed(2) + " kWh");
                        }else{
                            $("#solarUnitsConsumed").text((totalSolarUsed) + " Wh");
                        }
                       
                        $('#solarUnitsUsedToday').text($("#solarUnitsConsumed").text());

                        var todaySolarUseSavings = (totalSolarUsed/1000) * gridKwhPrice;
                        $('#solarUsedSavings').text('$ '+ todaySolarUseSavings.toFixed(2));

                        var feedInPay = (totalExport/1000) * feedInKwhPay;
                        $('#feedInPayToday').text('$ '+ feedInPay.toFixed(2));

                        var totalOverallSaving = todaySolarUseSavings + feedInPay - todayImportCost;
                        $('#totalSavedToday').text('$ ' + totalOverallSaving.toFixed(2));
                        if(totalOverallSaving > 0){
                            $('#totalSavedToday').attr('style', 'color:green');
                        }else{
                            $('#totalSavedToday').attr('style', 'color:red');
                        }

                        var synergyImpact = feedInPay - todayImportCost;
                        $('#synergyImpact').text('$ ' + synergyImpact.toFixed(2));
                        $('#estimateLiveCost').text($('#synergyImpact').text());

                        if(synergyImpact > 0){
                            $('#synergyImpact').attr('style', 'color:green');
                            $('#estimateLiveCost').attr('style', 'color:green');
                        }else{
                            $('#synergyImpact').attr('style', 'color:red');
                            $('#estimateLiveCost').attr('style', 'color:red');
                        }

                        if(new Date().getHours() == 23){
                            var hourRemainingMinutes = 60 - new Date().getMinutes();
                            if(finalDayNotificationSent || hourRemainingMinutes > 11)
                                return;

                           sendNotification('Final Numbers', 'Total Savings: $' + totalOverallSaving.toFixed(2) + ', Synergy Bill Impact: $' +  synergyImpact.toFixed(2) + ', Total Grid units used: ' + $('#gridUnitsUsedToday').text());
                           finalDayNotificationSent = true;
                        }
                    }

                }).fail(function(error){
                    console.log("pv load error: " + error);
                    $("#solarMeterData").hide();
                });

                //every 10 minutes
                setTimeout(function(){loadPVOutputData(false);}, 600000);
            }

            function failedLoading(){
                console.log('fail');
                        $('#afterhours').show();
                        $('#solarMeterData').hide();
                        $('#busyHours').hide();
                        $('#dayEnd_Error').show();
                        $('#stats').hide();
                        $("#dayEnd_Error").text("Error loading data from Server, probably no internet? ...");
                        setTimeout(function () { load(); loadWeather();}, timeout);
            }
        
        });

        var monthExpected;
        var newkWhMax;
        var oldkWhMax = 0; 
        var progressTimeout;
        var progressIncrements;
        var progressCounter = 0;
        var numberOfUpdates = 14;
        var progressTimeoutInterval = 0;
                           
        function setProgress(kWh, resetProgressTimeout){
            

            if(kWh == 0){
                $('#progressStandard').removeClass("progress-bar-striped"); 
                $('#progressStandard').removeClass("active"); 
                $('#overGenerated').removeClass("progress-bar-striped"); 
                $('#overGenerated').removeClass("active"); 
            }

            if(firstLoad){  
                oldkWhMax = kWh;
            }

            if(resetProgressTimeout){
                if(progressTimeout)
                    clearTimeout(progressTimeout);

                progressCounter = 0;
                newKWhMax = kWh;

                var diff = newKWhMax - oldkWhMax;
                progressIncrements = 0;

                progressTimeoutInterval = (timeout*2)/numberOfUpdates;
                progressIncrements = diff/numberOfUpdates;
                kWh = oldkWhMax + progressIncrements;
            }

            if(progressCounter == numberOfUpdates){
                return;
            }
            progressCounter++;

            var now = new Date();
            monthExpected = airconMonthEstimates[now.getMonth()];

            if(kWh <= monthExpected){
                $('#progressBeyond').hide();
                var percentage = 0
                if(kWh>0)
                    percentage = (kWh/monthExpected*100);
                $('#progressStandard').attr('style', 'width: ' + percentage + '%');
                $('#overGenerated').hide();

                if(kWh > 0){
                    if (!$('#progressStandard').hasClass('progress-bar-striped')){
                        $('#progressStandard').addClass("progress-bar-striped"); 
                    }
                    if (!$('#progressStandard').hasClass('active')){
                        $('#progressStandard').addClass("active"); 
                    }
                }

            }else{
                $('#progressBeyond').show();
                var percentage = (kWh/(kWh-monthExpected+kWh)*100);
                $('#progressStandard').attr('style', 'width: ' + percentage + '%');
                $('#progressBeyond').attr('style', 'width: ' + (100-percentage) + '%');
                $('#overGenerated').text((kWh-monthExpected).toFixed(1));
                $('#overGenerated').show();

                $('#progressStandard').removeClass("progress-bar-striped"); 
                $('#progressStandard').removeClass("active"); 

                if (!$('#overGenerated').hasClass('progress-bar-striped')){
                    $('#overGenerated').addClass("progress-bar-striped"); 
                }
                if (!$('#overGenerated').hasClass('active')){
                    $('#overGenerated').addClass("active"); 
                }

            }

            $("#powerTotal").text((kWh.toFixed(4)) + " kWh");

  
            oldkWhMax = kWh;
            var newVal = kWh + progressIncrements;
            progressTimeout = setTimeout(function(){ setProgress(newVal, false);  }, progressTimeoutInterval);
        }

        var mode = "NORMAL";
        function setGauge(value){
            if(value > 100 && mode !== "MAXIMUS"){
                mode = "MAXIMUS"
                gauge = new JustGage({
                    id: "gauge", // the id of the html element
                    value: value,
                    min: 0,
                    max: 100,
                    decimals: 2,
                    levelColors: ["#ff0000", "#f9c802", "#a9d70b", "#0083d6"],
                    gaugeWidthScale: 0.6
                });
            }else if(value <= 100 && mode !== "NORMAL"){
                mode = "NORMAL";
                gauge = new JustGage({
                    id: "gauge", // the id of the html element
                    value: value,
                    min: 0,
                    max: 100,
                    decimals: 2,
                    levelColors: ["#ff0000", "#f9c802", "#00b800"],
                    gaugeWidthScale: 0.6
                });
            }else{
                gauge.refresh(value);
            }
            
        }

        function getRecordPowerGeneratedForNow(powerGenCurrent){
            if(recordData === undefined){
                console.log('recordData not loaded');
                return;
            }

            if(powerGenCurrent == 0){
                return recordData[0][2];
            }

            var now = new Date();
            var closest5Min = Math.ceil(now.getMinutes()/5)*5;
            now.setMinutes(closest5Min);
            var key = formatAMPM(now);

            for (var i = 0; i < recordData.length; i++) {
                var obj = recordData[i];
                if(obj[1] === key){
                    return obj[2];
                }
            }

            return null;
           
            //return recordData.find(x => x[1] === key) !== undefined ? recordData.find(x => x[1] === key)[2] : null;
        }
        
        function formatAMPM(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0'+minutes : minutes;
            var strTime = hours + ':' + minutes + '' + ampm;
            return strTime;
        }

        function sendNotification(title, message){
            if(!queryString["key"]){
                return;
            }
            if(notificationCounter > maxNotifications){
                return;
            }else if(notificationCounter == maxNotifications){
                title = "MAX NOTIFICATIONS REACHED! - " + title;
            }

            var userKey =  queryString["key"];
            var data = {
                "token": "a5bp7hm1aosnsj3nthoozw75jsdhf9",
                "user": userKey,
                "title": title,
                "message": message
            };

            $.ajax({
                type: "POST",
                url: "https://api.pushover.net/1/messages.json",
                data: data,
                success: function(){},
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                contentType: 'application/x-www-form-urlencoded; charset=utf-8',
                dataType: 'json',
                success: function (response) {
                    notificationCounter++;
                    return response;
                }
            });
        }

        function loadWeather(){
            //try{
                $('#weatherWidget').attr('src', '');
                $('#weatherWidget').attr('src', "https://cdnres.willyweather.com.au/widget/loadView.html?id=57109");
             //   setTimeout(function () {$('#weatherWidget').attr('src', "https://cdnres.willyweather.com.au/widget/loadView.html?id=57109")},1000);
            //    setTimeout(function () { loadWeather(); }, 720000);
           // }catch(ex){
           //     setTimeout(function () { loadWeather(); }, 720000);
           // }
        }

        function changeTab(mode){
            $('li.tab').removeClass('active');
            $('#pvOutputIframe').attr('src','');
            $('div.section').hide();

            if(mode === 'home'){
                $('#homeSection').show();
                $('#home').addClass('active');
                
            }else if(mode === 'settings'){
                $('#settingsSection').show();
                $('#settings').addClass('active');
            }else if(mode === 'savings'){
                $('#savings').addClass('active');
                $('#savingsSection').show();
                $('#graphImage').attr('src', 'https://valuehold2.apphb.com/api/graph?oid='+queryString["oid"]);
            }else{
                $('#pvOutputIframe').hide();
                $('#pvOutputDiv').hide();
                $('#Weather').hide();
                $('#pvOutputSection').show();
                
                if(mode === 'pvOutput'){
                    $('#pvOutputDiv').show();
                    $('#pvOutput').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/intraday.jsp?id=84198&sid=74658');
                }
                else if(mode === 'pvOutputRecord'){
                    $('#pvOutputDiv').show();
                    $('#pvOutputRecord').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/intraday.jsp?id=84198&sid=74658&dt=20200409&gs=0&m=0');
                }    
                else if(mode === 'pvOutputDaily'){
                    $('#pvOutputDiv').show();
                    $('#pvOutputDaily').addClass('active');
                    $('#pvOutputIframe').attr('src','https://pvoutput.org/list.jsp?id=84198&sid=74658');
                }
                else if(mode === 'weather'){
                    console.log('here');
                    $('#Weather').show();
                    loadWeather();
                }

                $('#pvOutputIframe').show();  
            }
        }
    </script>
</body>

</html>
